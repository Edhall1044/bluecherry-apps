EXTDIR		:= $(shell php-config --extension-dir)
MODULE		= bluecherry
PHP_RPATH	= no
export PHP_RPATH

LDFLAGS  += -lavutil
CXXFLAGS += -fPIC -Wno-write-strings

export LD_LIBRARY_PATH=$(STAGE)/lib

all: modules/$(MODULE).so

configure: config.m4
	phpize
	aclocal && libtoolize --force && autoreconf

Makefile: configure
	./configure --with-php-config=php-config CXX="$(CXX)" LDFLAGS="$(LDFLAGS)"

modules/$(MODULE).so: Makefile $(LIB) FORCE
	$(MAKE) CXXFLAGS="$(CXXFLAGS)"

install: modules/$(MODULE).so $(MODULE).ini
	$(INSTALL_DATA) -D modules/$(MODULE).so \
		$(DESTDIR)$(EXTDIR)/$(MODULE).so
	$(INSTALL_DATA) -D $(MODULE).ini \
		$(DESTDIR)$(etc_dir)/php5/apache2/conf.d/bluecherry_apache2.ini
	$(INSTALL_DATA) -D $(MODULE).ini \
		$(DESTDIR)$(etc_dir)/php5/cli/conf.d/bluecherry_cli.ini
	$(INSTALL_DATA) -D $(MODULE).ini \
		$(DESTDIR)$(etc_dir)/php/7.0/mods-available/bluecherry.ini

clean:
	test -f Makefile && $(MAKE) -f Makefile distclean || true
	phpize --clean

FORCE:
